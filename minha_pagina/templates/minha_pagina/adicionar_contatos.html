{% load static %}
<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>Consumo de Água - Hotel</title>
  <link rel="stylesheet" href="{% static 'minha_pagina/style.css' %}">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body {
      background-color: #ffffff;
      color: #111b21;
      font-family: 'Inter', sans-serif;
      padding: 40px 0;
      margin: 0;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
      position: relative;
    }

    .top-right-buttons {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1100;
    }

    .top-right-buttons button {
      padding: 12px 24px;
      background-color: #ff8c00; /* laranja */
      border: none;
      border-radius: 8px;
      color: white;
      font-size: 16px;
      cursor: pointer;
      transition: background-color 0.3s ease;
      font-family: 'Inter', sans-serif;
    }

    .top-right-buttons button:hover {
      background-color: #e67e00;
    }

    .container {
      background-color: #f2f2f2;
      padding: 40px;
      border-radius: 12px;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
      text-align: center;
      width: 100%;
      max-width: 900px;
      box-sizing: border-box;
      margin-top: 60px;
      position: relative;
      z-index: 1;
      color: #111b21;
    }

    .titulo-com-botoes {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 15px;
      margin-bottom: 25px;
    }

    h1 {
      margin: 0;
      font-weight: 600;
      font-size: 28px;
    }

    #botaoAlterarConsumo {
      padding: 8px 16px;
      background-color: #ff8c00;
      border: none;
      border-radius: 8px;
      color: white;
      font-size: 14px;
      cursor: pointer;
      transition: background-color 0.3s ease;
      font-family: 'Inter', sans-serif;
    }

    #botaoAlterarConsumo:hover {
      background-color: #e67e00;
    }

    #botoesConsumoTipo {
      display: none;
      gap: 10px;
      margin-top: 10px;
      justify-content: center;
    }

    #botoesConsumoTipo button {
      padding: 8px 16px;
      background-color: #ff8c00;
      border: none;
      border-radius: 8px;
      color: white;
      font-size: 14px;
      cursor: pointer;
      transition: background-color 0.3s ease;
      font-family: 'Inter', sans-serif;
    }

    #botoesConsumoTipo button:hover {
      background-color: #e67e00;
    }

    input[type="number"] {
      width: 80%;
      padding: 12px;
      margin-bottom: 20px;
      border-radius: 8px;
      border: 1px solid #ddd;
      background-color: #ffffff;
      color: #111b21;
      font-size: 16px;
      font-family: 'Inter', sans-serif;
      box-sizing: border-box;
      transition: border-color 0.3s ease;
    }

    input[type="number"]:focus {
      border-color: #ff8c00;
      outline: none;
    }

    button[type="submit"],
    button[type="button"] {
      padding: 12px 25px;
      background-color: #ff8c00;
      border: none;
      border-radius: 8px;
      color: white;
      font-size: 16px;
      cursor: pointer;
      transition: background-color 0.3s ease;
      font-family: 'Inter', sans-serif;
      margin-top: 10px;
    }

    button[type="submit"]:hover,
    button[type="button"]:hover {
      background-color: #e67e00;
    }

    a {
      text-decoration: none;
      display: inline-block;
      margin-top: 15px;
    }

    /* Menu lateral com tema claro */
    .side-menu {
      position: fixed;
      top: 0;
      right: -260px;
      width: 250px;
      height: 100%;
      background-color: #f2f2f2;
      box-shadow: -2px 0 10px rgba(0, 0, 0, 0.1);
      padding: 20px;
      box-sizing: border-box;
      transition: right 0.3s ease;
      z-index: 2000;
    }

    .side-menu.open {
      right: 0;
    }

    .side-menu h3 {
      margin-top: 0;
      text-align: center;
      color: #111b21;
      font-family: 'Inter', sans-serif;
    }

    .side-menu a {
      display: block;
      margin: 15px 0;
      color: #111b21;
      text-decoration: none;
      font-family: 'Inter', sans-serif;
    }

    .side-menu button {
      width: 100%;
      background-color: #ff8c00;
      border: none;
      padding: 10px;
      border-radius: 8px;
      color: white;
      font-size: 16px;
      cursor: pointer;
      margin-bottom: 10px;
      font-family: 'Inter', sans-serif;
      transition: background-color 0.3s ease;
    }

    .side-menu button:hover {
      background-color: #e67e00;
    }

    .table-responsive {
      overflow-x: auto;
      margin-top: 30px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-family: 'Inter', sans-serif;
    }

    th, td {
      border: 1px solid #ddd;
      padding: 10px;
    }

    th {
      background-color: #ff8c00;
      color: white;
      font-weight: 600;
    }

    tr:hover {
      background-color: #ffe6cc;
    }
    

    @media (max-width: 640px) {
      .container {
        margin: 40px 20px;
        padding: 30px 20px;
      }

      h1 {
        font-size: 24px;
      }
    }

  </style>
</head>
<body>

  
<button id="btnLimparTabela" style="
  position: fixed;
  bottom: 70px; /* ajustado para ficar acima */
  right: 20px;
  background-color: #ff8c00;
  border: none;
  border-radius: 8px;
  color: white;
  font-size: 16px;
  padding: 12px 24px;
  cursor: pointer;
  font-family: 'Inter', sans-serif;
  z-index: 1500;
  transition: background-color 0.3s ease;
">Limpar Tabela</button>




<button id="btnBaixarPlanilha" style="
  position: fixed;
  bottom: 20px;
  right: 20px;
  background-color: #ff8c00;
  border: none;
  border-radius: 8px;
  color: white;
  font-size: 16px;
  padding: 12px 24px;
  cursor: pointer;
  font-family: 'Inter', sans-serif;
  z-index: 1500;
  transition: background-color 0.3s ease;
">Baixar Planilha</button>



  <div class="top-right-buttons">
    <button onclick="abrirMenu()">Ver opções</button>
  </div>

  <!-- Menu lateral oculto -->
  <div class="side-menu" id="sideMenu">
    <button onclick="fecharMenu()">Fechar</button>
    <h3>Menu</h3>
    <a href="{% url 'pagina_inicial' %}"><button>Página Inicial</button></a>
    <a href="{% url 'adicionar_contatos' %}"><button>Resgistro de consumos</button></a>
  </div>

  <div class="container">
    <div class="titulo-com-botoes">
      <h1 id="tituloConsumo">Consumo de Água - Hotel</h1>
      <button id="botaoAlterarConsumo" onclick="toggleBotoesConsumo()">Alterar consumo</button>
    </div>

    <div id="botoesConsumoTipo">
      <button onclick="selecionarTipoConsumo('Água')">Água</button>
      <button onclick="selecionarTipoConsumo('Gás')">Gás</button>
      <button onclick="selecionarTipoConsumo('Eletricidade')">Eletricidade</button>
    </div>

    <form id="consumoForm" method="post">
      {% csrf_token %}
      <input type="number" id="consumo_diario" name="consumo_diario" placeholder="Consumo diário em litros" step="0.01" min="0" required />
      <br />
      <input type="number" id="apartamentos_ocupados" name="apartamentos_ocupados" placeholder="Quantidade de apartamentos ocupados" min="1" required />
      <br />
      <div style="display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
        <button type="submit">Calcular</button>
        <button type="button" onclick="registrarVolumeInicial()">Registrar Volume Inicial</button>
      </div>

    </form>

    <div id="resultado" style="margin-top: 15px; font-weight: 600; color: #111b21;"></div>

<!-- parte inicial omitida por brevidade, até a tabela -->

<!-- Tabela para registrar cálculos de consumo -->
<div class="table-responsive">
  <table id="tabela-consumo" class="table table-bordered table-hover text-center align-middle">
    <thead class="table-light">
      <tr>
        <th>N°</th>
        <th id="thConsumoDiario">Consumo Diário (litros)</th>
        <th>Apartamentos Ocupados</th>
        <th id="thConsumoPorApartamento">Consumo por Apartamento (litros)</th>
        <th>Data</th>
        <th>Volume Inicial</th>
        <th>Volume Atual</th> <!-- nova coluna -->
      </tr>
    </thead>
    <tbody>
      <!-- Linhas adicionadas aqui via JS -->
    </tbody>
  </table>
</div>
</div>

<script>
  function abrirMenu() {
    document.getElementById("sideMenu").classList.add("open");
  }

  function fecharMenu() {
    document.getElementById("sideMenu").classList.remove("open");
  }

  const tabelaConsumoBody = document.querySelector("#tabela-consumo tbody");
  let contadorConsumo = 0;

  const botaoAlterarConsumo = document.getElementById('botaoAlterarConsumo');
  const botoesConsumoTipo = document.getElementById('botoesConsumoTipo');
  const tituloConsumo = document.getElementById('tituloConsumo');
  const inputConsumoDiario = document.getElementById('consumo_diario');
  const thConsumoDiario = document.getElementById('thConsumoDiario');
  const thConsumoPorApartamento = document.getElementById('thConsumoPorApartamento');

  let tipoConsumoAtual = 'Água';

  function toggleBotoesConsumo() {
    botoesConsumoTipo.style.display = botoesConsumoTipo.style.display === 'flex' ? 'none' : 'flex';
  }

  function salvarNoLocalStorage(registros) {
    localStorage.setItem('registrosConsumo', JSON.stringify(registros));
  }

  function carregarDoLocalStorage() {
    const registrosSalvos = localStorage.getItem('registrosConsumo');
    return registrosSalvos ? JSON.parse(registrosSalvos) : [];
  }

  function renderizarTabela(registros) {
    tabelaConsumoBody.innerHTML = '';
    const registrosReversos = registros.slice().reverse();
    registrosReversos.forEach((registro, index) => {
      const numeroOriginal = registros.length - index;
      const linha = document.createElement('tr');
      linha.innerHTML = `
        <td>${numeroOriginal}</td>
        <td>${registro.consumo}</td>
        <td>${registro.apartamentos}</td>
        <td>${registro.consumoPorApartamento}</td>
        <td>${registro.data || ''}</td>
        <td>${registro.volumeInicial || '-'}</td>
        <td>${registro.volumeAtual || '-'}</td> <!-- nova célula -->
      `;
      tabelaConsumoBody.appendChild(linha);
    });
    contadorConsumo = registros.length;
  }

  function selecionarTipoConsumo(tipo) {
    tipoConsumoAtual = tipo;
    tituloConsumo.textContent = `Consumo de ${tipo} - Hotel`;

    if (tipo === 'Água') {
      inputConsumoDiario.placeholder = "Novo Volume (litros)";
      thConsumoDiario.textContent = "Consumo diário em (litros)";
      thConsumoPorApartamento.textContent = "Consumo por Apartamento (litros)";
    } else if (tipo === 'Gás') {
      inputConsumoDiario.placeholder = "Novo Volume (m³)";
      thConsumoDiario.textContent = "Consumo diário em (m³)";
      thConsumoPorApartamento.textContent = "Consumo por Apartamento (m³)";
    } else if (tipo === 'Eletricidade') {
      inputConsumoDiario.placeholder = "Consumo diário em kWh";
      thConsumoDiario.textContent = "Consumo Diário (kWh)";
      thConsumoPorApartamento.textContent = "Consumo por Apartamento (kWh)";
    }

    botoesConsumoTipo.style.display = 'none';
    document.getElementById('resultado').textContent = '';
    document.getElementById('consumoForm').reset();

    const registros = carregarDoLocalStorage().filter(r => r.tipo === tipoConsumoAtual);
    renderizarTabela(registros);
  }
  document.getElementById('consumoForm').addEventListener('submit', function(event) {
    event.preventDefault();

    const novoVolumeAtual = parseFloat(document.getElementById('consumo_diario').value);
    const apartamentos = parseInt(document.getElementById('apartamentos_ocupados').value);

    if (apartamentos <= 0) {
      alert("A quantidade de apartamentos ocupados deve ser maior que zero.");
      return;
    }

    if (isNaN(novoVolumeAtual) || novoVolumeAtual < 0) {
      alert("Informe um volume atual válido (número positivo).");
      return;
    }

    let consumo, volumeInicial, volumeAnterior;

    if (tipoConsumoAtual === 'Eletricidade') {
      // Para eletricidade, o usuário já fornece diretamente o consumo, não é necessário volume inicial
      consumo = novoVolumeAtual;
      volumeInicial = '-';
      volumeAnterior = '-';
    } else {
      volumeAnterior = obterVolumeAtualMaisRecente(tipoConsumoAtual);

      if (volumeAnterior === null) {
        alert(`Não há volume inicial registrado para ${tipoConsumoAtual}. Registre-o antes.`);
        return;
      }

      if (novoVolumeAtual > volumeAnterior) {
        alert("O novo volume atual não pode ser maior que o volume anterior.");
        return;
      }

      consumo = volumeAnterior - novoVolumeAtual;
      volumeInicial = localStorage.getItem(`volumeInicial_${tipoConsumoAtual}`) || '-';
    }

    const consumoPorApartamento = consumo / apartamentos;

    document.getElementById('resultado').textContent =
      `Consumo médio de ${tipoConsumoAtual.toLowerCase()} por apartamento: ${consumoPorApartamento.toFixed(2)} ` +
      (tipoConsumoAtual === 'Água' ? 'litros' : tipoConsumoAtual === 'Gás' ? 'm³' : 'kWh');

    const novoRegistro = {
      tipo: tipoConsumoAtual,
      consumo: consumo.toFixed(2),
      apartamentos: apartamentos,
      consumoPorApartamento: consumoPorApartamento.toFixed(2),
      data: new Date().toLocaleDateString('pt-BR'),
      volumeInicial: volumeInicial,
      volumeAtual: tipoConsumoAtual === 'Eletricidade' ? '-' : novoVolumeAtual.toFixed(2)
    };

    const registros = carregarDoLocalStorage();
    registros.push(novoRegistro);
    salvarNoLocalStorage(registros);

    renderizarTabela(registros.filter(r => r.tipo === tipoConsumoAtual));

    this.reset();
  });



  // Inicializa tipo padrão e carrega dados do localStorage
  selecionarTipoConsumo(tipoConsumoAtual);


  function calcularVolumeAtual(volumeAnterior, consumo) {
    const vAnterior = parseFloat(volumeAnterior);
    const vConsumo = parseFloat(consumo);

    if (isNaN(vAnterior)) return '-';
    if (isNaN(vConsumo)) return vAnterior.toFixed(2);

    const volumeAtual = vAnterior - vConsumo;
    return volumeAtual >= 0 ? volumeAtual.toFixed(2) : '0.00';
  }


    function obterVolumeAtualMaisRecente(tipo) {
    const registros = carregarDoLocalStorage().filter(r => r.tipo === tipo && !isNaN(parseFloat(r.volumeAtual)));
    if (registros.length === 0) return null;

    const ultimoRegistro = registros[registros.length - 1];
    return parseFloat(ultimoRegistro.volumeAtual);
  }

  function registrarVolumeInicial() {
    if (tipoConsumoAtual === 'Água' || tipoConsumoAtual === 'Gás') {
      const unidade = tipoConsumoAtual === 'Água' ? 'litros' : 'm³';
      const volume = prompt(`Digite o volume inicial de ${tipoConsumoAtual.toLowerCase()} (${unidade}):`);
      if (volume !== null && !isNaN(volume) && volume.trim() !== "") {
        const volumeFormatado = parseFloat(volume).toFixed(2);

        alert(`Volume inicial de ${tipoConsumoAtual.toLowerCase()} registrado: ${volumeFormatado} ${unidade}`);

        // Salva no localStorage para uso futuro
        localStorage.setItem(`volumeInicial_${tipoConsumoAtual}`, volumeFormatado);

        const registros = carregarDoLocalStorage();

        const novoRegistro = {
          tipo: tipoConsumoAtual,
          consumo: '-',
          apartamentos: '-',  // hífen por ser volume apenas
          consumoPorApartamento: '-',
          data: new Date().toLocaleDateString('pt-BR'),
          volumeInicial: volumeFormatado,
          volumeAtual: volumeFormatado  // aqui está a parte importante
        };

        registros.push(novoRegistro);
        salvarNoLocalStorage(registros);
        renderizarTabela(registros.filter(r => r.tipo === tipoConsumoAtual));
      } else {
        alert("Entrada inválida. Certifique-se de digitar um número.");
      }
    } else {
      alert(`O botão Registrar Volume Inicial só funciona para consumo de Água ou Gás.`);
    }
  }


  document.getElementById("btnLimparTabela").addEventListener("click", function () {
    if (confirm("Tem certeza que deseja limpar a tabela? Isso apagará os dados salvos.")) {
      // Limpar registros do tipo atual do localStorage
      const todosRegistros = carregarDoLocalStorage();
      const registrosFiltrados = todosRegistros.filter(r => r.tipo !== tipoConsumoAtual);
      salvarNoLocalStorage(registrosFiltrados);

      // Atualizar a tabela renderizada
      renderizarTabela([]);
      
      // Limpar a área de resultado
      document.getElementById("resultado").textContent = '';
    }
  });


  btnBaixarPlanilha.addEventListener('click', () => {
  const tabela = document.getElementById('tabela-consumo');
  if (!tabela) {
    alert('Tabela não encontrada!');
    return;
  }

  // Template HTML básico para Excel, incluindo meta charset para evitar problemas com caracteres acentuados
  const templateExcel = `
    <html xmlns:o="urn:schemas-microsoft-com:office:office"
          xmlns:x="urn:schemas-microsoft-com:office:excel"
          xmlns="http://www.w3.org/TR/REC-html40">
    <head>
      <meta charset="UTF-8">
      <!--[if gte mso 9]>
      <xml>
        <x:ExcelWorkbook>
          <x:ExcelWorksheets>
            <x:ExcelWorksheet>
              <x:Name>Consumo</x:Name>
              <x:WorksheetOptions><x:DisplayGridlines/></x:WorksheetOptions>
            </x:ExcelWorksheet>
          </x:ExcelWorksheets>
        </x:ExcelWorkbook>
      </xml>
      <![endif]-->
    </head>
    <body>
      ${tabela.outerHTML}
    </body>
    </html>`;

  const blob = new Blob([templateExcel], { type: 'application/vnd.ms-excel;charset=utf-8' });
  const filename = 'consumo_hotel.xls';

  if (window.navigator && window.navigator.msSaveOrOpenBlob) {
    // Para IE e Edge antigos
    window.navigator.msSaveOrOpenBlob(blob, filename);
  } else {
    // Para outros navegadores
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = filename;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);

    // Revoga o objeto URL depois do download
    setTimeout(() => URL.revokeObjectURL(link.href), 100);
  }
});


</script>


</body>
</html>
